// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Product model - stores all product information
model Product {
  id              String      @id @default(cuid())
  name            String
  price           Float       // Final selling price to customer
  basePrice       Float?      // Cost from AliExpress (for profit tracking)
  discount        Float?      // Discount percentage (replaces profitMargin)
  image           String
  images          String[]    @default([]) // Multiple product images
  category        String
  rating          Float       @default(4.5)
  reviews         Int         @default(0)
  description     String      @db.Text
  features        String[]
  inStock         Boolean     @default(true)
  stockQuantity   Int?        @default(0) // Track inventory quantity
  sku             String?     @unique // Stock keeping unit
  aliexpressUrl   String?     // Link to source product on AliExpress
  aliexpressId    String?     // AliExpress product ID for easy reference
  keywords        String[]    @default([]) // SEO keywords
  metaDescription String?     @db.Text // SEO meta description
  orderItems      OrderItem[]
  variants        ProductVariant[] // Product variants (sizes, colors, etc.)
  productReviews  Review[]    // Customer reviews
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([category])
  @@index([inStock])
  @@index([rating])
}

// Customer model - stores customer information
model Customer {
  id            String   @id @default(cuid())
  email         String   @unique
  name          String
  password      String?  // Hashed password (optional for guest checkout)
  phone         String?

  // Shipping address
  address       String?
  city          String?
  state         String?
  zipCode       String?
  country       String?  @default("United States")

  orders        Order[]
  reviews       Review[]
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([email])
}

// Order model - tracks all orders
model Order {
  id                  String      @id @default(cuid())
  orderNumber         String

  // Customer information
  customerId          String
  customer            Customer    @relation(fields: [customerId], references: [id])

  // Order details
  orderItems          OrderItem[]
  status              OrderStatus @default(PENDING)
  subtotal            Float
  shippingCost        Float       @default(0)
  tax                 Float       @default(0)
  total               Float
  paymentStatus       PaymentStatus @default(PENDING)
  paymentMethod       String?

  // Payment information
  stripePaymentId     String?     @unique

  // Shipping information
  shippingName        String
  shippingEmail       String
  shippingPhone       String?
  shippingAddress     String
  shippingCity        String
  shippingState       String
  shippingZip         String
  shippingCountry     String      @default("United States")

  // Fulfillment tracking
  trackingNumber      String?
  trackingUrl         String?
  aliexpressOrderId   String?
  aliexpressOrderUrl  String?

  // Notes
  customerNotes       String?     @db.Text
  adminNotes          String?     @db.Text

  // Timestamps
  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt
  shippedAt           DateTime?
  deliveredAt         DateTime?

  @@index([customerId])
  @@index([status])
  @@index([stripePaymentId])
  @@index([createdAt])
}

// OrderItem model - individual items within an order
model OrderItem {
  id              String   @id @default(cuid())

  order           Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  orderId         String

  product         Product  @relation(fields: [productId], references: [id])
  productId       String

  quantity        Int
  price           Float    // Price at time of purchase (in case product price changes)

  // Snapshot of product details at time of order
  productName     String
  productImage    String

  createdAt       DateTime @default(now())

  @@index([orderId])
  @@index([productId])
}

// Admin model - for admin user authentication
model Admin {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String   // Hashed password
  name      String
  role      AdminRole @default(ADMIN)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
}

// Enums for order status
enum OrderStatus {
  PENDING           // Order received, payment pending
  PAID              // Payment confirmed
  PROCESSING        // Order being prepared
  ORDERED_SUPPLIER  // Ordered from AliExpress
  SHIPPED           // Shipped to customer
  DELIVERED         // Delivered to customer
  CANCELLED         // Order cancelled
  REFUNDED          // Order refunded
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum AdminRole {
  SUPER_ADMIN
  ADMIN
  STAFF
}

// Email Subscriber model - stores newsletter/VIP list signups
model EmailSubscriber {
  id          String   @id @default(cuid())
  email       String   @unique
  name        String
  source      String?  @default("vip_signup") // Where they signed up from
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([email])
  @@index([createdAt])
}

// Coupon model - stores discount codes
model Coupon {
  id              String    @id @default(cuid())
  code            String    @unique // Coupon code (e.g., "SAVE20")
  description     String?   @db.Text
  discountType    String    // "FIXED" or "PERCENTAGE"
  discountValue   Float     // Fixed amount or percentage (e.g., 20 for 20% or $20)
  maxUses         Int?      // Maximum number of times coupon can be used (null = unlimited)
  currentUses     Int       @default(0) // Number of times already used
  minOrderAmount  Float?    // Minimum order amount to apply coupon
  maxDiscountAmount Float?  // Maximum discount amount (for percentage discounts)
  isActive        Boolean   @default(true)
  startDate       DateTime?
  endDate         DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([code])
  @@index([isActive])
}

// ProductVariant model - stores product variants (size, color, etc.)
model ProductVariant {
  id              String   @id @default(cuid())
  product         Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId       String

  name            String   // e.g., "Size: Large", "Color: Red"
  sku             String?  // Variant SKU
  price           Float?   // Variant-specific price (if different from base)
  discount        Float?   // Variant-specific discount percentage
  stockQuantity   Int      @default(0)
  isActive        Boolean  @default(true)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([productId])
}

// Cart model - stores shopping cart data for abandoned cart tracking
model Cart {
  id              String      @id @default(cuid())
  sessionId       String      @unique // Browser session ID or user ID
  customerEmail   String?     // Optional email if provided
  items           CartItem[]
  total           Float       @default(0)
  lastUpdated     DateTime    @updatedAt
  recoveryEmailSent Boolean   @default(false) // Track if recovery email was sent
  createdAt       DateTime    @default(now())

  @@index([sessionId])
  @@index([lastUpdated])
  @@index([recoveryEmailSent])
}

// CartItem model - individual items in shopping cart
model CartItem {
  id              String   @id @default(cuid())
  cart            Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)
  cartId          String
  productId       String
  productName     String
  productImage    String
  price           Float
  quantity        Int
  createdAt       DateTime @default(now())

  @@index([cartId])
  @@index([productId])
}

// Review model - customer product reviews
model Review {
  id              String       @id @default(cuid())
  product         Product      @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId       String
  customer        Customer?    @relation(fields: [customerId], references: [id], onDelete: SetNull)
  customerId      String?
  customerName    String       // Stored separately in case customer is deleted
  customerEmail   String       // For verification
  rating          Int          // 1-5 stars
  title           String?      // Optional review title
  comment         String       @db.Text
  verified        Boolean      @default(false) // Verified purchase
  helpful         Int          @default(0) // Helpful count
  images          String[]     @default([]) // Review images
  response        String?      @db.Text // Admin/seller response
  status          ReviewStatus @default(PENDING)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@index([productId])
  @@index([customerId])
  @@index([status])
  @@index([rating])
  @@index([createdAt])
}

enum ReviewStatus {
  PENDING       // Awaiting moderation
  APPROVED      // Approved and visible
  REJECTED      // Rejected by moderator
  FLAGGED       // Flagged for review
}

// FooterLink model - editable footer navigation links
model FooterLink {
  id          String   @id @default(cuid())
  section     String   // e.g., "Shop", "Customer Service", "Company"
  label       String   // Link text
  url         String   // Link URL
  order       Int      @default(0) // Display order within section
  isActive    Boolean  @default(true)
  openInNewTab Boolean @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([section])
  @@index([order])
  @@index([isActive])
}
